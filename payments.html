<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Paystack Payments & Receipts &bull; Da4lions Pay-tec</title>
        <link rel="icon" type="image/png" sizes="32x32" href="/assets/lion-logo-32.png?v=2" />
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/lion-logo-16.png?v=2" />
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/lion-logo-180.png?v=2" />
    <link rel="stylesheet" href="assets/style.css" />
  </head>
  <body data-page="payments">
    <header class="topbar">
      <div class="brand brand-mark"><img src="/assets/da4lions-logo.jpeg" alt="Da4lions Pay-tec logo" class="brand-logo" /><span class="brand-copy">Da4lions Pay-tec</span></div>
      <button id="menuButton" class="menu-btn" aria-label="Toggle navigation">&#9776;</button>
      <nav id="mainNav" class="nav-links">
        <a href="index.html"><img class="nav-link__icon" src="/assets/icons8-home-48.png" alt="" aria-hidden="true" />Home</a>
        <a href="notifications.html"><img class="nav-link__icon" src="/assets/icons8-notification-48.png" alt="" aria-hidden="true" />Notifications</a>
        <a href="handouts.html"><img class="nav-link__icon" src="/assets/icons8-books-50.png" alt="" aria-hidden="true" />Handouts</a>
        <a class="active" href="payments.html"><img class="nav-link__icon" src="/assets/icons8-cash-and-credit-card-50.png" alt="" aria-hidden="true" />Payments</a>
        <a href="/lecturer" data-role-link="lecturer" hidden><img class="nav-link__icon" src="/assets/icons8-lecturer-50.png" alt="" aria-hidden="true" />Lecturer</a>
        <button id="profileToggleButton" class="profile-trigger" type="button"><img class="nav-link__icon" src="/assets/icons8-profile-24.png" alt="" aria-hidden="true" />Profile</button>
        <form method="post" action="/logout" class="logout-form">
          <input type="hidden" name="_csrf" value="" />
          <button type="submit" class="logout-btn">Log out</button>
        </form>
      </nav>
    </header>

    <main class="container">
      <section class="page-title">
        <h1>Paystack Payments</h1>
        <p>Pay with Paystack and download approved receipts after confirmation.</p>
      </section>

      <p id="paymentsError" class="auth-error" hidden></p>

      <section id="studentPaymentsSection" class="grid two-col" hidden>
        <article class="card">
          <h2>My Payment Ledger</h2>
          <div class="grid two-col">
            <p><strong>Total Due:</strong> <span id="ledgerTotalDue">-</span></p>
            <p><strong>Approved Paid:</strong> <span id="ledgerApprovedPaid">-</span></p>
            <p><strong>Pending Review:</strong> <span id="ledgerPendingPaid">-</span></p>
            <p><strong>Outstanding:</strong> <span id="ledgerOutstanding">-</span></p>
            <p><strong>Overdue Items:</strong> <span id="ledgerOverdueCount">0</span></p>
            <p><strong>Due Soon:</strong> <span id="ledgerDueSoonCount">0</span></p>
          </div>
          <p><strong>Next Due:</strong> <span id="ledgerNextDue">No upcoming due item.</span></p>
        </article>

        <article class="card">
          <h2>Due-Date Reminder Calendar</h2>
          <p class="auth-subtitle">Auto-generated reminders based on payment due dates.</p>
          <p id="paystackCheckoutStatus" class="auth-subtitle"></p>
          <div id="paymentReminderRows" class="details-tile-list" aria-live="polite"></div>
        </article>

        <article class="card">
          <h2>Webhook Fallback</h2>
          <p id="postPaystackReferenceStatus" class="auth-subtitle">
            If your Paystack payment remains pending, post the reference directly to lecturers for manual verification.
          </p>
          <form id="postPaystackReferenceForm" class="auth-form">
            <label for="postPaystackReferenceInput">Paystack reference</label>
            <input id="postPaystackReferenceInput" type="text" maxlength="120" placeholder="e.g. 7PVGX8MEK85" required />

            <label for="postPaystackReferenceNote">Note (optional)</label>
            <textarea
              id="postPaystackReferenceNote"
              rows="2"
              maxlength="300"
              placeholder="e.g. Payment completed but still waiting for webhook confirmation."
            ></textarea>

            <button id="postPaystackReferenceButton" type="submit" class="btn btn-secondary">Post Reference to Lecturer</button>
          </form>
          <div id="myPaystackReferenceRequestRows" class="details-tile-list" aria-live="polite"></div>
        </article>

        <article class="card">
          <h2>Payment Timeline</h2>
          <p class="auth-subtitle">Recent reconciliation status updates.</p>
          <div class="table-wrap">
            <table class="data-table">
              <thead>
                <tr>
                  <th>When</th>
                  <th>Payment Item</th>
                  <th>Action</th>
                  <th>Note</th>
                </tr>
              </thead>
              <tbody id="paymentTimelineRows"></tbody>
            </table>
          </div>
        </article>

        <article class="card">
          <h2>My Approved Receipts</h2>
          <div id="myReceiptRows" class="details-tile-list" aria-live="polite"></div>
        </article>
      </section>

      <section id="reviewPaymentsSection" class="grid two-col" hidden>
        <article class="card">
          <h2>Create Payment Item</h2>
          <p id="paymentItemStatus" class="auth-subtitle"></p>
          <form id="paymentItemForm" class="auth-form">
            <label for="paymentItemTitle">Title</label>
            <input id="paymentItemTitle" type="text" maxlength="120" required />

            <label for="paymentItemDescription">Description</label>
            <textarea id="paymentItemDescription" rows="3"></textarea>

            <label for="paymentItemAmount">Expected Amount</label>
            <input id="paymentItemAmount" type="number" min="0.01" step="0.01" required />

            <label for="paymentItemCurrency">Currency</label>
            <input id="paymentItemCurrency" type="text" maxlength="3" value="NGN" required />

            <label for="paymentItemDueDate">Due Date (optional)</label>
            <input id="paymentItemDueDate" type="date" />

            <label for="paymentItemAvailabilityDays">Available for (days, optional)</label>
            <input id="paymentItemAvailabilityDays" type="number" min="1" step="1" placeholder="e.g. 30" />

            <button type="submit" class="btn">Save Payment Item</button>
          </form>
        </article>

        <article class="card">
          <h2>Manage Payment Items</h2>
          <div id="paymentItemRows" class="details-tile-list" aria-live="polite"></div>
        </article>

        <article class="card">
          <h2>Verify Paystack Reference</h2>
          <p id="verifyPaystackStatus" class="auth-subtitle">Use this when a successful Paystack payment has not reflected yet.</p>
          <form id="verifyPaystackForm" class="auth-form">
            <label for="verifyPaystackReference">Paystack reference</label>
            <input
              id="verifyPaystackReference"
              type="text"
              maxlength="120"
              placeholder="e.g. 7PVGX8MEK85"
              required
            />
            <button id="verifyPaystackButton" type="submit" class="btn">Verify Reference</button>
          </form>
        </article>

        <article class="card" style="grid-column: 1 / -1;">
          <h2>Paystack Reference Requests</h2>
          <p id="paystackReferenceRequestsStatus" class="auth-subtitle">
            Posted by students when webhook confirmation is delayed.
          </p>
          <div class="table-wrap">
            <table class="data-table">
              <thead>
                <tr>
                  <th><input id="paystackReferenceRequestsSelectAll" type="checkbox" aria-label="Select all paystack reference requests" /></th>
                  <th>Requested</th>
                  <th>Student</th>
                  <th>Item</th>
                  <th>Reference</th>
                  <th>Note</th>
                  <th>Status</th>
                  <th>Result</th>
                </tr>
              </thead>
              <tbody id="paystackReferenceRequestRows"></tbody>
            </table>
          </div>
          <div style="display:flex;gap:0.6rem;align-items:center;flex-wrap:wrap;margin-top:0.65rem;">
            <button id="verifySelectedPaystackRequestsButton" type="button" class="btn">Verify Selected References</button>
            <button id="refreshPaystackRequestsButton" type="button" class="btn btn-secondary">Refresh Requests</button>
          </div>
        </article>
      </section>

      <section id="receiptQueueSection" class="card" style="margin-top: 1rem;" hidden>
        <h2>Approved Transactions</h2>
        <div class="recon-summary-tabs" style="margin-bottom:0.8rem;">
          <article class="card recon-summary-tab">
            <h3>Approved Transactions</h3>
            <p id="reconAutoApproved" class="auth-subtitle">0</p>
          </article>
          <article class="card recon-summary-tab">
            <h3>Exceptions</h3>
            <p id="reconExceptions" class="auth-subtitle">0</p>
          </article>
          <article class="card recon-summary-tab">
            <h3>Unresolved Obligations</h3>
            <p id="reconUnresolved" class="auth-subtitle">0</p>
          </article>
          <article class="card recon-summary-tab">
            <h3>Duplicates</h3>
            <p id="reconDuplicates" class="auth-subtitle">0</p>
          </article>
        </div>
        <form id="queueFilterForm" class="auth-form" style="margin-bottom: 0.8rem;">
          <div class="filter-grid">
            <label>
              Student Name / Username
              <input id="queueStudent" type="text" placeholder="Search name or username" />
            </label>
            <label>
              Paystack Reference
              <input id="queueReference" type="text" placeholder="Search reference" />
            </label>
            <label>
              Date From
              <input id="queueDateFrom" type="date" />
            </label>
            <label>
              Date To
              <input id="queueDateTo" type="date" />
            </label>
            <label>
              Payment Item
              <select id="queuePaymentItem">
                <option value="">All</option>
              </select>
            </label>
            <div class="filter-actions">
              <button type="submit" class="btn btn-secondary">Apply Filters</button>
            </div>
          </div>
        </form>

        <div class="table-wrap">
          <table class="data-table">
            <thead>
              <tr>
                <th>Student Name</th>
                <th>Username</th>
                <th>Payment Item</th>
                <th>Amount</th>
                <th>Paystack Reference</th>
                <th>Approved Date/Time</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="receiptQueueRows"></tbody>
          </table>
        </div>
        <div style="display:flex;gap:0.6rem;align-items:center;margin-top:0.65rem;">
          <button id="queuePrevPage" type="button" class="btn btn-secondary">Previous</button>
          <button id="queueNextPage" type="button" class="btn btn-secondary">Next</button>
          <span id="queuePageInfo" class="auth-subtitle">Page 1</span>
        </div>

      </section>
    </main>

    <script src="assets/csrf.js"></script>
    <script src="assets/app.js"></script>
    <script src="assets/payments.js"></script>
    <script src="assets/profile.js"></script>
  </body>
</html>
